---
title: 10.2 Javac编译器 10.2.3 注解处理器
categories: 
  - 7 深入理解Java虛拟机：JVM高级特性与最佳实践(第3版)
  - 4第四部分 程序编译与代码优化
  - 第10章 前端编译与优化
  - 10.2 Javac编译器
abbrlink: 39027c49
date: 2021-11-25 20:38:08
updated: 2021-11-28 15:26:08
---
# 10.2.3 注解处理器
JDK 5之后，Java语言提供了对注解（Annotations）的支持，注解在设计上原本是与普通的Java代 码一样，都只会在程序运行期间发挥作用的。但在JDK 6中又提出并通过了JSR-269提案[^1]，该提案设 计了一组被称为“插入式注解处理器”的标准API，可以提前至编译期对代码中的特定注解进行处理， 从而影响到前端编译器的工作过程。我们可以把插入式注解处理器看作是一组编译器的插件，当这些 插件工作时，允许读取、修改、添加抽象语法树中的任意元素。如果这些插件在处理注解期间对语法 树进行过修改，编译器将回到解析及填充符号表的过程重新处理，直到所有插入式注解处理器都没有 再对语法树进行修改为止，每一次循环过程称为一个轮次（Round），这也就对应着图10-4的那个回环 过程。

有了编译器注解处理的标准API后，程序员的代码才有可能干涉编译器的行为，由于语法树中的任意元素，甚至包括代码注释都可以在插件中被访问到，所以通过插入式注解处理器实现的插件在功能上有很大的发挥空间。只要有足够的创意，程序员能使用插入式注解处理器来实现许多原本只能在编码中由人工完成的事情。譬如Java著名的编码效率工具Lombok[^2]，它可以通过注解来实现自动产生getter/setter方法、进行空置检查、生成受查异常表、产生equals()和hashCode()方法，等等，帮助开发人员消除Java的冗长代码，这些都是依赖插入式注解处理器来实现的，本章最后会设计一个如何使用插入式注解处理器的简单实战。

在Javac源码中，插入式注解处理器的初始化过程是在initPorcessAnnotations()方法中完成的，而它的执行过程则是在processAnnotations()方法中完成。这个方法会判断是否还有新的注解处理器需要执行，如果有的话，通过com.sun.tools.javac.processing.JavacProcessing-Environment类的doProcessing()方法来生成一个新的JavaCompiler对象，对编译的后续步骤进行处理。

[^1]: JSR-269：Pluggable Annotations Processing API（插入式注解处理API）。 
[^2]: 主页地址：https://projectlombok.org/。
